#!/usr/bin/env python3
"""
Full Pipeline Integration Test

This script demonstrates the complete job application automation workflow:
1. Scrapes a real job posting from a URL
2. Personalizes a LaTeX resume using GPT-OSS 20B
3. Generates a custom cover letter using GPT-OSS 20B  
4. Provides a fit score assessment
5. Saves all outputs with metadata

This is a comprehensive test of all the major components working together.
"""

import sys
import os
from datetime import datetime

# Add the src directory to the path so we can import our modules
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from job_scraper import JobScraper, JobPosting
from latex_resume_processor import LaTeXResumeProcessor
from cover_letter_generator import CoverLetterGenerator
from ollama_integration import OllamaIntegration


def print_separator(title: str):
    """Print a nice separator with title."""
    print("=" * 70)
    print(f"  {title}")
    print("=" * 70)


def print_job_info(job: JobPosting):
    """Print formatted job information."""
    print(f"🏢 Company: {job.company}")
    print(f"📋 Title: {job.title}")
    print(f"📍 Location: {job.location}")
    print(f"🔗 URL: {job.url}")
    print(f"🛠️  Skills Required: {', '.join(job.skills[:5])}{'...' if len(job.skills) > 5 else ''}")
    print(f"📝 Requirements: {len(job.requirements)} found")
    print(f"📄 Description Length: {len(job.description)} characters")


def save_summary_report(job_posting, resume_result, cover_letter_result, fit_score, output_dir):
    """Save a summary report of the entire process."""
    report_path = os.path.join(output_dir, "application_summary.md")
    
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    report_content = f"""# Job Application Summary Report

**Generated:** {timestamp}
**Job:** {job_posting.title} at {job_posting.company}

## Job Details
- **URL:** {job_posting.url}
- **Location:** {job_posting.location}
- **Skills Required:** {', '.join(job_posting.skills)}

## Generated Outputs
- **Resume:** `personalized_resume.tex`
- **Cover Letter:** `personalized_cover_letter.md`
- **Fit Score:** {fit_score.fit_score}/100

## Key Personalizations

### Resume Changes
{chr(10).join([f"- {change}" for change in resume_result.key_changes])}

### Cover Letter Highlights
- Tone: {cover_letter_result.tone}
- Skills Emphasized: {', '.join(cover_letter_result.skills_highlighted)}

## Fit Assessment

### Strengths
{chr(10).join([f"- {strength}" for strength in fit_score.strengths])}

### Areas for Improvement
{chr(10).join([f"- {weakness}" for weakness in fit_score.weaknesses])}

### Missing Skills
{chr(10).join([f"- {skill}" for skill in fit_score.missing_skills])}

### Recommendations
{chr(10).join([f"- {rec}" for rec in fit_score.recommendations])}

---
*Generated by Job Application Automator using GPT-OSS 20B*
"""
    
    with open(report_path, 'w', encoding='utf-8') as f:
        f.write(report_content)
    
    print(f"📊 Summary report saved: {report_path}")


def main():
    """Run the full pipeline test."""
    print_separator("🚀 JOB APPLICATION AUTOMATION - FULL PIPELINE TEST")
    
    # Define sample job posting that's always available as fallback
    sample_job = JobPosting(
        url="https://example.com/sample-job",
        title="Senior Software Engineer - Machine Learning",
        company="InnovateTech Solutions",
        location="San Francisco, CA",
        description="We are seeking a Senior Software Engineer with expertise in machine learning and AI to join our growing team. You will work on cutting-edge projects involving large language models, computer vision, and natural language processing. The ideal candidate has experience with Python, TensorFlow, PyTorch, and cloud platforms like AWS. You should be comfortable working in an agile environment and have a passion for solving complex technical challenges.",
        skills=['python', 'machine learning', 'tensorflow', 'pytorch', 'aws', 'nlp', 'computer vision', 'ai'],
        requirements=['5+ years software engineering experience', 'MS/PhD in Computer Science or related field', 'Experience with ML frameworks', 'Strong Python programming skills', 'Cloud platform experience']
    )
    
    # Prompt for job URL
    print("\n🔍 Please provide a job posting URL to test with:")
    print("Examples:")
    print("- https://jobs.lever.co/...")
    print("- https://boards.greenhouse.io/...")
    print("- https://careers.company.com/...")
    print("- Or any company careers page")
    
    job_url = input("\n🌐 Enter job posting URL: ").strip()
    
    if not job_url:
        # Use the sample job for testing
        job_url = sample_job.url
        print(f"Using sample job for testing: {job_url}")
        use_sample = True
    else:
        use_sample = False
    
    # Create output directory with timestamp
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    output_dir = f"/Users/lbrevoort/Desktop/projects/job-application-automator/output/full_test_{timestamp}"
    os.makedirs(output_dir, exist_ok=True)
    
    try:
        print_separator("🕷️  STEP 1: SCRAPING JOB POSTING")
        
        if use_sample:
            job_posting = sample_job
            print("Using sample job posting for demonstration...")
        else:
            # Initialize job scraper
            print("🔄 Initializing job scraper...")
            with JobScraper(use_selenium=False, headless=True) as scraper:
                print(f"🌐 Scraping job posting: {job_url}")
                job_posting = scraper.scrape_job(job_url)
        
        print_job_info(job_posting)
        
        if not job_posting.title or "Error:" in job_posting.title:
            print("❌ Failed to scrape job posting properly. Using sample data...")
            job_posting = sample_job
            print_job_info(job_posting)
        
        print_separator("📄 STEP 2: PERSONALIZING RESUME")
        
        # Initialize resume processor
        print("🔄 Initializing LaTeX resume processor...")
        resume_processor = LaTeXResumeProcessor()
        
        # Generate personalized resume
        print(f"✏️  Personalizing resume for {job_posting.title}...")
        resume_result = resume_processor.personalize_resume(
            job_posting=job_posting,
            output_path=os.path.join(output_dir, "personalized_resume.tex")
        )
        
        print("✅ Resume personalization complete!")
        print(f"   Key changes: {len(resume_result.key_changes)}")
        for change in resume_result.key_changes[:3]:
            print(f"   - {change}")
        
        print_separator("💌 STEP 3: GENERATING COVER LETTER")
        
        # Initialize cover letter generator
        print("🔄 Initializing cover letter generator...")
        cover_letter_generator = CoverLetterGenerator()
        
        # Personal information for cover letter header
        personal_info = {
            'name': 'Luke Brevoort',
            'location': 'Littleton, CO',
            'phone': '720-862-5457',
            'email': 'luke@brevoort.com',
            'website': 'luke.brevoort.com'
        }
        
        # Generate personalized cover letter
        print(f"✏️  Generating cover letter for {job_posting.company}...")
        cover_letter_result = cover_letter_generator.generate_personalized_cover_letter(
            job_posting=job_posting,
            personal_info=personal_info,
            output_path=os.path.join(output_dir, "personalized_cover_letter.md")
        )
        
        print("✅ Cover letter generation complete!")
        print(f"   Tone: {cover_letter_result.tone}")
        print(f"   Skills highlighted: {', '.join(cover_letter_result.skills_highlighted)}")
        
        print_separator("🎯 STEP 4: ASSESSING FIT SCORE")
        
        # Initialize Ollama integration for fit scoring
        print("🔄 Assessing candidate fit...")
        ollama_client = OllamaIntegration()
        
        # Get resume content for fit assessment
        with open(os.path.join(output_dir, "personalized_resume.tex"), 'r') as f:
            resume_text = f.read()
        
        # Assess fit score
        fit_score = ollama_client.assess_fit_score(
            resume_content=resume_text[:3000],  # First 3k chars
            job_posting=job_posting,
            cover_letter=cover_letter_result.markdown_content[:1500]  # First 1.5k chars
        )
        
        print("✅ Fit assessment complete!")
        print(f"   🎯 Fit Score: {fit_score.fit_score}/100")
        print(f"   💪 Top Strengths: {', '.join(fit_score.strengths[:2])}")
        print(f"   📈 Confidence Level: {fit_score.confidence_level}")
        
        print_separator("📊 STEP 5: GENERATING SUMMARY")
        
        # Save comprehensive summary report
        save_summary_report(job_posting, resume_result, cover_letter_result, fit_score, output_dir)
        
        print_separator("🎉 PIPELINE TEST COMPLETED SUCCESSFULLY!")
        
        print(f"📁 All outputs saved to: {output_dir}")
        print("\n📋 Generated Files:")
        print(f"   📄 personalized_resume.tex")
        print(f"   💌 personalized_cover_letter.md") 
        print(f"   📊 application_summary.md")
        print(f"   🔧 personalized_resume_metadata.json")
        
        print(f"\n🎯 Final Results:")
        print(f"   Company: {job_posting.company}")
        print(f"   Position: {job_posting.title}")
        print(f"   Fit Score: {fit_score.fit_score}/100")
        print(f"   Assessment: {'🟢 Strong Match' if fit_score.fit_score >= 75 else '🟡 Moderate Match' if fit_score.fit_score >= 60 else '🔴 Weak Match'}")
        
        print("\n🚀 Ready to submit your personalized application!")
        
    except Exception as e:
        print(f"\n❌ Error during pipeline execution: {e}")
        print(f"   Check the logs for more details.")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
